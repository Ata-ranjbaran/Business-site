<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>درگاه پرداخت | وب لجندر</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .payment-container {
            animation: fadeInUp 0.6s ease-out;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .card-input {
            letter-spacing: 2px;
        }
        .card-input::placeholder {
            letter-spacing: 0;
        }
        .card-logo {
            opacity: 0.3;
            transition: all 0.3s ease;
        }
        .card-logo.active {
            opacity: 1;
            transform: scale(1.2);
        }
        #visaLogo.active {
            color: #1434CB;
        }
        #mastercardLogo.active {
            color: #EB001B;
        }
        #amexLogo.active {
            color: #006FCF;
        }
    </style>
</head>
<body>
    <div class="payment-container max-w-6xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="inline-block bg-white/20 backdrop-blur-lg rounded-full p-4 mb-4">
                <i class="fas fa-credit-card text-white text-4xl"></i>
            </div>
            <h1 class="text-4xl font-bold text-white mb-2">درگاه پرداخت امن</h1>
            <p class="text-white/80">لطفاً اطلاعات کارت بانکی خود را وارد کنید</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Payment Form -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-3xl shadow-2xl p-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                        <i class="fas fa-lock text-blue-600"></i>
                        اطلاعات پرداخت
                    </h2>

                    <form onsubmit="handlePayment(event)" class="space-y-6">
                        <!-- Card Number -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-credit-card text-blue-600 ml-2"></i>شماره کارت
                            </label>
                            <div class="relative">
                                <input type="text" id="cardNumber" required maxlength="19"
                                    class="card-input w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all"
                                    placeholder="1234 5678 9012 3456"
                                    oninput="formatCardNumber(this); detectCardType(this.value)">
                                <div class="absolute left-4 top-1/2 transform -translate-y-1/2 flex gap-2">
                                    <i class="fab fa-cc-visa text-2xl text-gray-300 card-logo" id="visaLogo"></i>
                                    <i class="fab fa-cc-mastercard text-2xl text-gray-300 card-logo" id="mastercardLogo"></i>
                                    <i class="fab fa-cc-amex text-2xl text-gray-300 card-logo" id="amexLogo"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Card Holder Name -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-user text-blue-600 ml-2"></i>نام صاحب کارت
                            </label>
                            <input type="text" id="cardName" required
                                class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all"
                                placeholder="نام و نام خانوادگی"
                                style="text-transform: uppercase;">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <!-- Expiry Date -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-calendar text-blue-600 ml-2"></i>تاریخ انقضا
                                </label>
                                <input type="text" id="cardExpiry" required maxlength="5"
                                    class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all"
                                    placeholder="MM/YY"
                                    oninput="formatExpiry(this)">
                            </div>

                            <!-- CVV -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-lock text-blue-600 ml-2"></i>CVV
                                </label>
                                <input type="text" id="cardCVV" required maxlength="4"
                                    class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all"
                                    placeholder="123"
                                    oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 rounded-xl font-bold text-lg hover:from-blue-700 hover:to-purple-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                            <i class="fas fa-check-circle ml-2"></i>تایید و پرداخت
                        </button>
                    </form>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-3xl shadow-2xl p-6 sticky top-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                        <i class="fas fa-shopping-bag text-blue-600"></i>
                        خلاصه سفارش
                    </h2>

                    <div id="orderItems" class="space-y-4 mb-6">
                        <!-- Items will be loaded here -->
                    </div>

                    <div class="border-t border-gray-200 pt-4 space-y-3">
                        <div class="flex justify-between text-gray-600">
                            <span>جمع کل:</span>
                            <span id="orderTotal" class="font-semibold">0 ریال</span>
                        </div>
                        <div class="flex justify-between text-gray-600">
                            <span>مالیات:</span>
                            <span class="font-semibold">0 ریال</span>
                        </div>
                        <div class="flex justify-between text-xl font-bold text-gray-900 pt-2 border-t border-gray-200">
                            <span>مبلغ قابل پرداخت:</span>
                            <span id="finalTotal" class="text-blue-600">0 ریال</span>
                        </div>
                    </div>

                    <div class="mt-6 p-4 bg-blue-50 rounded-xl">
                        <div class="flex items-center gap-2 text-blue-700 text-sm">
                            <i class="fas fa-shield-alt"></i>
                            <span>پرداخت امن و رمزگذاری شده</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load cart items
        function loadOrderSummary() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const orderItems = document.getElementById('orderItems');
            const orderTotal = document.getElementById('orderTotal');
            const finalTotal = document.getElementById('finalTotal');

            if (cart.length === 0) {
                window.location.href = 'index.html';
                return;
            }

            let total = 0;
            orderItems.innerHTML = cart.map(item => {
                const itemPrice = item.pricingType === 'free' ? 0 : (item.price || 0);
                total += itemPrice;
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 text-sm">${item.name}</h4>
                            <p class="text-xs text-gray-500">${item.description || ''}</p>
                        </div>
                        <span class="font-bold text-blue-600">${itemPrice > 0 ? formatPrice(itemPrice) + ' ریال' : 'رایگان'}</span>
                    </div>
                `;
            }).join('');

            orderTotal.textContent = formatPrice(total) + ' ریال';
            finalTotal.textContent = formatPrice(total) + ' ریال';
        }

        function formatPrice(price) {
            return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function formatCardNumber(input) {
            let value = input.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            input.value = formattedValue;
        }

        function formatExpiry(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            input.value = value;
        }

        function detectCardType(cardNumber) {
            const number = cardNumber.replace(/\s/g, '');
            const visaLogo = document.getElementById('visaLogo');
            const mastercardLogo = document.getElementById('mastercardLogo');
            const amexLogo = document.getElementById('amexLogo');

            // Reset all
            [visaLogo, mastercardLogo, amexLogo].forEach(logo => {
                logo.classList.remove('active');
            });

            if (/^4/.test(number)) {
                visaLogo.classList.add('active');
            } else if (/^5[1-5]/.test(number)) {
                mastercardLogo.classList.add('active');
            } else if (/^3[47]/.test(number)) {
                amexLogo.classList.add('active');
            }
        }

        function handlePayment(event) {
            event.preventDefault();
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            // Check if all items are free
            const allFree = cart.every(item => item.pricingType === 'free' || item.price === 0);
            
            if (allFree) {
                // All items are free, download immediately
                handleFreeOrder();
                return;
            }
            
            // Has paid items, need payment
            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            const cardName = document.getElementById('cardName').value;
            const cardExpiry = document.getElementById('cardExpiry').value;
            const cardCVV = document.getElementById('cardCVV').value;

            // Basic validation
            if (cardNumber.length < 16) {
                alert('شماره کارت باید 16 رقم باشد!');
                return;
            }

            if (cardExpiry.length !== 5) {
                alert('تاریخ انقضا را به درستی وارد کنید!');
                return;
            }

            if (cardCVV.length < 3) {
                alert('CVV باید حداقل 3 رقم باشد!');
                return;
            }

            // Disable submit button
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>در حال پردازش...';

            // Simulate payment processing
            setTimeout(() => {
                // Save order with pending status (needs admin approval)
                const order = {
                    id: Date.now(),
                    userId: currentUser.id || null,
                    userName: currentUser.name || 'نامشخص',
                    userEmail: currentUser.email || '',
                    items: cart,
                    total: cart.reduce((sum, item) => sum + (item.pricingType === 'free' ? 0 : (item.price || 0)), 0),
                    paymentMethod: 'card',
                    cardNumber: cardNumber.substring(cardNumber.length - 4), // Last 4 digits
                    status: 'pending', // Pending admin approval
                    createdAt: new Date().toISOString()
                };

                // Save order to localStorage
                const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                orders.push(order);
                localStorage.setItem('orders', JSON.stringify(orders));

                // Dispatch event for admin panel
                window.dispatchEvent(new CustomEvent('ordersUpdated'));

                // Clear cart
                localStorage.removeItem('cart');

                // Redirect to success page
                window.location.href = 'payment-success.html?orderId=' + order.id + '&pending=true';
            }, 2000);
        }

        function handleFreeOrder() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            // Create order with completed status for free items
            const order = {
                id: Date.now(),
                userId: currentUser.id || null,
                userName: currentUser.name || 'نامشخص',
                userEmail: currentUser.email || '',
                items: cart,
                total: 0,
                paymentMethod: 'free',
                status: 'completed',
                createdAt: new Date().toISOString()
            };

            // Save order to localStorage
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            orders.push(order);
            localStorage.setItem('orders', JSON.stringify(orders));

            // Save to user downloads
            const userDownloads = JSON.parse(localStorage.getItem('userDownloads') || '[]');
            cart.forEach(item => {
                userDownloads.push({
                    orderId: order.id,
                    itemId: item.id,
                    itemName: item.name,
                    itemType: item.type,
                    downloadedAt: new Date().toISOString()
                });
            });
            localStorage.setItem('userDownloads', JSON.stringify(userDownloads));

            // Clear cart
            localStorage.removeItem('cart');

            // Download immediately (simulate)
            alert('محصولات رایگان شما آماده دانلود است!');
            
            // Redirect to user panel or success page
            window.location.href = 'user-panel.html?download=true';
        }

        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', () => {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                // User not logged in, redirect to login
                window.location.href = 'login.html';
                return;
            }

            loadOrderSummary();
        });
    </script>
</body>
</html>

